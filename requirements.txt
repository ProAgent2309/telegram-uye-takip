import sqlite3
from datetime import datetime, timedelta
from telegram import Update
from telegram.ext import Application, ChatMemberHandler, CommandHandler, ContextTypes
import asyncio

# ============ BURAYA KENDÄ° BÄ°LGÄ°LERÄ°NÄ°ZÄ° YAZIN ============
BOT_TOKEN = "8445241488:AAFKvQUiX69Qu3E_Lx_ufr35sJPDHa4eW4w"  # BotFather'dan aldÄ±ÄŸÄ±nÄ±z token
GROUP_CHAT_ID = -1003339131587  # Grup ID'si (Ã¶rnek: -1003339131587)
PERSONAL_CHAT_ID = 5563748743  # Sizin kiÅŸisel ID'niz - BurasÄ± bildirimler iÃ§in
# ==========================================================

# VeritabanÄ± oluÅŸtur
def init_db():
    conn = sqlite3.connect('uyeler.db')
    c = conn.cursor()
    c.execute('''CREATE TABLE IF NOT EXISTS uyeler
                 (user_id INTEGER PRIMARY KEY,
                  username TEXT,
                  first_name TEXT,
                  join_date TEXT,
                  notified INTEGER DEFAULT 0)''')
    conn.commit()
    conn.close()

# Yeni Ã¼ye ekle
def add_member(user_id, username, first_name):
    conn = sqlite3.connect('uyeler.db')
    c = conn.cursor()
    join_date = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    try:
        c.execute("INSERT OR IGNORE INTO uyeler (user_id, username, first_name, join_date) VALUES (?, ?, ?, ?)",
                  (user_id, username, first_name, join_date))
        conn.commit()
        print(f"âœ… Yeni Ã¼ye eklendi: {first_name} (@{username}) - {join_date}")
    except Exception as e:
        print(f"âŒ Hata: {e}")
    conn.close()

# Ãœye deÄŸiÅŸikliklerini takip et
async def track_members(update: Update, context: ContextTypes.DEFAULT_TYPE):
    result = update.chat_member
    
    if result.new_chat_member.status in ["member", "administrator"]:
        if result.old_chat_member.status in ["left", "kicked"]:
            user = result.new_chat_member.user
            user_id = user.id
            username = user.username or "kullanÄ±cÄ±_adÄ±_yok"
            first_name = user.first_name or "Ä°simsiz"
            
            add_member(user_id, username, first_name)
            
            # Gruba bildirim gÃ¶nder (isteÄŸe baÄŸlÄ±)
            await context.bot.send_message(
                chat_id=update.effective_chat.id,
                text=f"ğŸ‘‹ HoÅŸ geldin {first_name}! KaydÄ±n alÄ±ndÄ±."
            )

# 30 gÃ¼nlÃ¼k Ã¼yeleri kontrol et
async def check_30_days(context: ContextTypes.DEFAULT_TYPE):
    conn = sqlite3.connect('uyeler.db')
    c = conn.cursor()
    
    today = datetime.now()
    
    c.execute("SELECT user_id, username, first_name, join_date FROM uyeler WHERE notified = 0")
    members = c.fetchall()
    
    for user_id, username, first_name, join_date in members:
        join_date_obj = datetime.strptime(join_date, "%Y-%m-%d %H:%M:%S")
        days_passed = (today - join_date_obj).days
        
        if days_passed >= 30:
            # UyarÄ± mesajÄ± gÃ¶nder - SADECE SÄ°ZE Ã–ZEL
            message = f"âš ï¸ 30 GÃœN UYARISI\n\n"
            message += f"ğŸ‘¤ Ãœye: {first_name}\n"
            message += f"ğŸ“± KullanÄ±cÄ± adÄ±: @{username}\n"
            message += f"ğŸ“… GiriÅŸ tarihi: {join_date}\n"
            message += f"â° GeÃ§en sÃ¼re: {days_passed} gÃ¼n\n"
            
            # Mesaj sizin kiÅŸisel chat'inize gÃ¶nderilir
            await context.bot.send_message(chat_id=PERSONAL_CHAT_ID, text=message)
            
            # Bildirildi olarak iÅŸaretle
            c.execute("UPDATE uyeler SET notified = 1 WHERE user_id = ?", (user_id,))
            conn.commit()
            print(f"âœ… 30 gÃ¼n bildirimi gÃ¶nderildi: {first_name}")
    
    conn.close()

# /start komutu
async def start_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "ğŸ¤– Ãœye Takip Botu Aktif!\n\n"
        "âœ… Yeni Ã¼yeler otomatik kaydediliyor\n"
        "âœ… 30 gÃ¼nde bir uyarÄ± alacaksÄ±nÄ±z\n\n"
        "Komutlar:\n"
        "/liste - TÃ¼m Ã¼yeleri gÃ¶ster\n"
        "/istatistik - Ä°statistikleri gÃ¶ster"
    )

# /liste komutu - TÃ¼m Ã¼yeleri gÃ¶ster
async def list_members(update: Update, context: ContextTypes.DEFAULT_TYPE):
    conn = sqlite3.connect('uyeler.db')
    c = conn.cursor()
    c.execute("SELECT first_name, username, join_date, notified FROM uyeler ORDER BY join_date DESC")
    members = c.fetchall()
    conn.close()
    
    if not members:
        await update.message.reply_text("âŒ HenÃ¼z kayÄ±tlÄ± Ã¼ye yok.")
        return
    
    message = "ğŸ“‹ KAYITLI ÃœYELER\n\n"
    for i, (first_name, username, join_date, notified) in enumerate(members, 1):
        status = "âœ…" if notified else "â³"
        message += f"{i}. {status} {first_name} (@{username})\n"
        message += f"   ğŸ“… {join_date}\n\n"
        
        if i % 20 == 0:  # Her 20 Ã¼yede bir mesajÄ± gÃ¶nder
            await update.message.reply_text(message)
            message = ""
    
    if message:
        await update.message.reply_text(message)

# /istatistik komutu
async def statistics(update: Update, context: ContextTypes.DEFAULT_TYPE):
    conn = sqlite3.connect('uyeler.db')
    c = conn.cursor()
    
    c.execute("SELECT COUNT(*) FROM uyeler")
    total = c.fetchone()[0]
    
    c.execute("SELECT COUNT(*) FROM uyeler WHERE notified = 1")
    notified = c.fetchone()[0]
    
    conn.close()
    
    message = f"ğŸ“Š Ä°STATÄ°STÄ°KLER\n\n"
    message += f"ğŸ‘¥ Toplam Ã¼ye: {total}\n"
    message += f"âœ… Bildirim gÃ¶nderilen: {notified}\n"
    message += f"â³ Bekleyen: {total - notified}\n"
    
    await update.message.reply_text(message)

# Ana fonksiyon
def main():
    # VeritabanÄ±nÄ± baÅŸlat
    init_db()
    
    # Bot uygulamasÄ±nÄ± oluÅŸtur
    application = Application.builder().token(BOT_TOKEN).build()
    
    # Handler'larÄ± ekle
    application.add_handler(ChatMemberHandler(track_members, ChatMemberHandler.CHAT_MEMBER))
    application.add_handler(CommandHandler("start", start_command))
    application.add_handler(CommandHandler("liste", list_members))
    application.add_handler(CommandHandler("istatistik", statistics))
    
    # GÃ¼nlÃ¼k kontrol iÅŸi ekle (her gÃ¼n saat 10:00'da Ã§alÄ±ÅŸÄ±r)
    job_queue = application.job_queue
    job_queue.run_daily(check_30_days, time=datetime.strptime("10:00", "%H:%M").time())
    
    # Botu baÅŸlat
    print("ğŸ¤– Bot baÅŸlatÄ±lÄ±yor...")
    print(f"âœ… Bot aktif! Grup ID: {GROUP_CHAT_ID}")
    print(f"ğŸ“± Bildirimler gidecek: {PERSONAL_CHAT_ID}")
    print("â° GÃ¼nlÃ¼k kontrol: Her gÃ¼n saat 10:00")
    
    application.run_polling(allowed_updates=Update.ALL_TYPES)

if __name__ == '__main__':
    main()